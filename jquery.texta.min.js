(function($){$.fn.texta=function(options){var defaults={background:"yellow",footnotes:false,comments:false,strikeout:false,count:0,lock:false,skip:false,active:0},settings=$.extend({},defaults,options);this.each(function(index){var $this=$(this);if(settings.footnotes)$this.after('<fieldset class="texta-footnotes"><legend>Footnotes</legend><ul id="texta-footnotes-'+index+'"></fieldset>');$this.after('<fieldset id="texta-comment-fieldset-'+index+'" class="texta-comments"><legend>Edit This Annotation</legend></fieldset>');
if(settings.comments){$("#texta-comment-fieldset-"+index).append('<textarea id="texta-comment-'+index+'"></textarea><input id="texta-comment-update-'+index+'" type="button" value="Update">');$("#texta-comment-update-"+index).click(function(){$("#texta-note-"+settings.active).html('<sup id="texta-super-'+settings.active+'">'+(settings.active+1)+"</sup> "+$("#texta-"+settings.active).html()+' - <span class="texta-footnotes-comment">'+$("#texta-comment-"+index).val()+"</span>");$("#texta-"+settings.active).attr("data-texta-comment",
$("#texta-comment-"+index).val());$("#texta-comment-"+index).val("");$("#texta-comment-fieldset-"+index).css({"display":"none"})})}$("#texta-comment-fieldset-"+index).append('<input id="texta-comment-remove-'+index+'" type="button" value="Remove">');$("#texta-comment-fieldset-"+index).append('<input id="texta-comment-cancel-'+index+'" type="button" value="Close">');$("#texta-comment-remove-"+index).click(function(){$("#texta-"+settings.active).contents().unwrap();$("#texta-super-"+settings.active).remove();
$("#texta-note-"+settings.active).remove();$(this).parent().css({"display":"none"})});$("#texta-comment-cancel-"+index).click(function(){$(this).parent().css({"display":"none"})});$this.mouseup(function(e){if(!settings.lock&&$("#texta-comment-fieldset-"+index).css("display")!="block"){settings.lock=true;if(String(window.getSelection()).length==0)return false;var range=window.getSelection().getRangeAt(0);var clonedRange=range.cloneContents();var selectedText=String(window.getSelection());selectedText=
selectedText.replace(/\n/gi,"<br />");document.all?document.selection.empty():window.getSelection().removeAllRanges();for(var i=0;i<clonedRange.childNodes.length;i++)if(clonedRange.childNodes[i].nodeName=="P"||(clonedRange.childNodes[i].nodeName=="DIV"||clonedRange.childNodes[i].nodeName=="SPAN")){if(clonedRange.childNodes[i].nodeName=="SPAN");settings.skip=true}if(!settings.skip){var newNode=document.createElement("span");newNode.id="texta-"+settings.count;settings.active=settings.count;settings.count++;
newNode.innerHTML=selectedText;range.deleteContents();range.insertNode(newNode);$("#"+newNode.id).addClass("texta-highlight");$("#"+newNode.id).addClass("texta-highlight-"+settings.background);if(settings.strikeout)$("#"+newNode.id).addClass("texta-highlight-strikeout");$("#"+newNode.id).data("texta-id",settings.count-1);$("#"+newNode.id).click(function(){settings.active=$(this).data("texta-id");$("#texta-comment-"+index).val($("#texta-"+settings.active).attr("data-texta-comment"));$("#texta-comment-fieldset-"+
index).css({"display":"block"})});if(settings.footnotes){var superscript='<sup id="texta-super-'+(settings.count-1)+'">'+settings.count+"</sup>";$("#"+newNode.id).after(superscript);$("#texta-footnotes-"+index).append('<li id="texta-note-'+(settings.count-1)+'">'+superscript+" "+$("#"+newNode.id).html()+"</li>")}}else settings.skip=false;if(settings.comments)$("#texta-comment-fieldset-"+index).css({"display":"block"})}settings.lock=false})});return this}})(jQuery);
